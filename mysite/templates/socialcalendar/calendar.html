{% extends "template.html" %}
{% block main %}

<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.tinyscrollbar.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}/timePicker/js/bootstrap-datetimepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/css/tinyscrollbar.css" />
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/timePicker/css/bootstrap-datetimepicker.min.css"/>

<div class="alert alert-info">
    <p>You have a new event request from:</p>
    <div class="row-fluid">
        <div class="span4"></div>
        <div class="span2">
            <button class="btn btn-block btn-success" type="button">Accept</button>
        </div>
        <div class="span2">
            <button class="btn btn-block btn-danger" type="button">Reject</button>     
        </div>
        <div class="span4"></div>
    </div>
</div>
<div class="alert alert-info">
    <p>You have a new event request from:</p>
    <div class="row-fluid">
        <div class="span4"></div>
        <div class="span2">
            <button class="btn btn-block btn-success" type="button">Accept</button>
        </div>
        <div class="span2">
            <button class="btn btn-block btn-danger" type="button">Reject</button>     
        </div>
        <div class="span4"></div>
    </div>
</div>


<div class="row">
    <div class="span1"><button type="button" id="calendarBack" class="btn btn-block btn-primary">&lt&lt</button></div>
    <div class="span1"><button type="button" id="calendarToday" class="btn btn-block btn-primary">Today</button></div>
    <div class="span1"><button type="button" id="calendarForward" class="btn btn-block btn-primary">&gt&gt</button></div>
    <div class="span6"><h4 id="weekname">{{ header }}</h4></div>
    <div class="span1"></div>
    <div class="span1"><button type="button" class="btn btn-block btn-primary">Monthly</button></div>
    <div class="span1"><button type="button" class="btn btn-block btn-primary">Weekly</button></div>
</div>

<div class="row">
    <div class="span12"><p></p></div>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th width="5.5%"></th>
            {% for day in days %}
            <th class="headings" width="13.5%">{{day.title}}</th>
            {% endfor %}
        </tr>
    </thead>
</table>
<div id="scrollbar1" class="noSelect">
    <div class="scrollbar"><div class="track"><div class="thumb"><div class="end"></div></div></div></div>
    <div class="viewport">
        <div class="overview">
           <div class='dragged'></div>
            <div class="calendarTable">
                <table>
                    <tbody>
                        {% for hour in hours %}
                        <tr class="calendarRow">
                            <td class="hourEntry" rowspan="2" width="5.5%">{{hour}}</td>
                            {% for day in days %}
                            {% if day.today %}
                            <td class="calendarEntry calendarToday" width="13.5%"></td>
                            {% else %}
                            <td class="calendarEntry" width="13.5%"></td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                        <tr class="calendarRow">
                            {% for day in days %}
                            {% if day.today %}
                            <td class="calendarHalfHour calendarToday" width="13.5%"></td>
                            {% else %}
                            <td class="calendarHalfHour" width="13.5%"></td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="span12"><p></p></div>
</div>

<div class="btn-group" data-toggle="buttons-radio">

    <div class="row">
        <div class="span3"><button type="button" class="btn btn-block btn-inverse">Time Block</button></div>
        <div class="span3"><button type="button" class="btn btn-block btn-inverse">Private</button></div>
        <div class="span3"><button type="button" class="btn btn-block btn-inverse">Public</button></div>
        <div class="span3"><button type="button" class="btn btn-block btn-inverse">Friends</button></div>
    </div>


</div>
<div class="row">
    <div class="span12"><p></p></div>
</div>

<!-- Modal -->
<div id="eventModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <form>
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            <h3 id="myModalLabel"><input id="eventName" class="input-block-level" type="text" placeholder="Event Name"></h3>
        </div>
        <div class="modal-body">
            <div class="row-fluid">
                <div class="span6">
                    <div id="datetimepicker" class="input-append">
                        <input id="startTime" data-format="MM/dd/yyyy HH:mm PP" type="text"></input>
                        <span class="add-on">
                            <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                        </span>
                    </div>
                </div>
                <div class="span6">
                    <div id="datetimepicker2" class="input-append">
                        <input id="endTime" data-format="MM/dd/yyyy HH:mm PP" type="text"></input>
                        <span class="add-on">
                            <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                        </span>
                    </div>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <input id="eventLocation" class="input-block-level" type="text" placeholder="Event Location">
                </div>
            </div>
            <textarea id="eventDescription" class="input-block-level" placeholder="Event Description..." rows="10"></textarea>
        </div>
    </form>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <button class="btn btn-danger" id="deleteEvent">Delete</button>
        <button class="btn btn-primary" id="editEvent">Edit</button>
        <button class="btn btn-primary" id="createEvent">Create</button>
    </div>
</div>


<script type="text/javascript">

    var currentlyViewing = -1;
    var clearModal = function () {
        $("#eventName").val("");
        $("#eventDescription").val("");
        $("#eventLocation").val("");
    }

    var dates = new Array();
    {% for date in dates %}
    dates.push(new Date({{ date.year }},
            {{ date.month }},
            {{ date.day }}));
    {% endfor %}
    $(document).ready(function(){

            var scrollBar = $('#scrollbar1');
            scrollBar.tinyscrollbar({wheel: 34});
            scrollBar.tinyscrollbar_update(272);

            });

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    var csrftoken = getCookie('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    
$.ajaxSetup({
    crossDomain: false, // obviates need for sameOrigin test
    beforeSend: function(xhr, settings) {
    if (!csrfSafeMethod(settings.type)) {
    xhr.setRequestHeader("X-CSRFToken", csrftoken);
    }
    }
    });


    var populateEvents = function() {
        $.get('populateEvents', function (data, status) {
                $('.event').remove();
                $overview = $('.overview');
                var x = $('.hourEntry').width();
                var width = $('.calendarEntry').width();
                var height = $('.calendarEntry').height();
                var borderWidth = 1;
            $.each(data, function(index, dat) {
                $div = $('<div class="event" id="'+dat.id+'">'+dat.title+'</div>');
                        $div.height((height+borderWidth)*(dat.end - dat.start)*2);
                        $div.width(width+borderWidth);
                        $div.offset({top: (height+borderWidth)*dat.start*2, left: x + width*dat.day + 2*borderWidth*(dat.day+1)});

                        $overview.prepend($div);
                    });

            $('.event').off('click');
            $('.event').on('click', function (){
                clearModal();

        $.post('getEventData', {"id": $(this).attr('id')}, function (data, status) {
                $("#eventName").val(data.title);
                $("#eventDescription").val(data.description);
                $("#eventLocation").val(data.location);
                $("#eventStart").val(data.start);
                $("#eventEnd").val(data.end);

                $('#createEvent').hide();
                $('#deleteEvent').show();
                $('#editEvent').show();
                $('#eventModal').modal();

                currentlyViewing = data.id;

            }, "json");
        return false;
                });
            $('.event').on('mousemove', function (event){
                event.preventDefault();
                return false;
                    });


        }, "json");
    }
$(document).ready(function(){
        populateEvents();
        });

    var updateCalendar = function(amount) {
        $.post('changeWeek', {"amount": amount}, function (data, status) {
                $("#weekname").html(data.header);
                $.each(data.dates, function(index, date) {
                    dates[index] = new Date(date.year,
                                    date.month,
                                    date.day);
                    });
                var $cells1 = $(".calendarEntry");
                var $cells2 = $(".calendarHalfHour");
                $cells1.removeClass("calendarToday");
                $cells2.removeClass("calendarToday");

                var hasToday = -1;
                $(".headings").each(function(index) {
                    $(this).html(data.days[index].title);
                    if (data.days[index].today == true) {
                    hasToday = index;
                    }
                    });
                

                if (hasToday >= 0) {
                    $cells1.each(function(index) {
                        if (index % 7 == hasToday)
                            $(this).addClass("calendarToday");
                            });
                    $cells2.each(function(index) {
                        if (index % 7 == hasToday)
                            $(this).addClass("calendarToday");
                            });
                }
        }, "json").done(function() {
                populateEvents();
            });
    }

    $("#calendarBack").click(function() {updateCalendar(-1)});
    $("#calendarToday").click(function() {updateCalendar(0)});
    $("#calendarForward").click(function() {updateCalendar(1)});



    var createEvent = function() {
        $.post('submitEvent', {"title": $("#eventName").val(), 
                                "description": $("#eventDescription").val(),
                                "location": $("#eventLocation").val(),
                                "startTime": $("#startTime").val(),
                                "endTime": $("#endTime").val()}, 
                                 "json").done(function (data, status) {
                                    populateEvents();
                                });
        $('#eventModal').modal('hide');
    }
    $("#createEvent").click(function() {createEvent()});

    var deleteEvent = function() {
        $.post('deleteEvent', {"id": currentlyViewing}, 
                                 "json").done(function (data, status) {
                                    populateEvents();
                                });
        $('#eventModal').modal('hide');
    }
    $("#deleteEvent").click(function() {deleteEvent()});



</script>

<script type="text/javascript" src="{{ STATIC_URL }}/js/draggable.js"></script>
{% endblock main %}
